<template>
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center p-4">
    <div class="max-w-md w-full">
      
      <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ -->
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 p-8">
        
        <!-- Ø§Ù„Ø´Ø¹Ø§Ø± -->
        <div class="text-center mb-8">
          <div class="w-16 h-16 rounded-2xl flex items-center justify-center bg-gradient-to-br from-[#1B3C53] to-[#234C6A] mx-auto mb-4 shadow-lg">
            <span class="material-icons text-white text-2xl">person_add</span>
          </div>
          <h2 class="text-2xl font-bold text-[#1B3C53] dark:text-white mb-2">Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯</h2>
          <p class="text-[#456882] dark:text-gray-300">Ù…Ø±ÙƒØ² ØµØ§Ù„Ø­ Ø¨Ù† ØµØ§Ù„Ø­ - Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·ÙÙ„ Ø§Ù„Ø±Ù‚Ù…ÙŠØ©</p>
        </div>

        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ -->
        <form @submit.prevent="handleRegister" class="space-y-6">
          
          <!-- Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ -->
          <div>
            <label class="block text-sm font-medium mb-2 text-[#1B3C53] dark:text-gray-300">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <div class="relative">
              <span class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-[#456882] dark:text-gray-400 text-lg">person</span>
              <input 
                type="text" 
                v-model="form.fullName"
                required
                placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„ÙƒØ§Ù…Ù„"
                class="w-full px-4 py-3 pr-10 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
              >
            </div>
          </div>

          <!-- Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ -->
          <div>
            <label class="block text-sm font-medium mb-2 text-[#1B3C53] dark:text-gray-300">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <div class="relative">
              <span class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-[#456882] dark:text-gray-400 text-lg">email</span>
              <input 
                type="email" 
                v-model="form.email"
                required
                placeholder="Ø§Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
                class="w-full px-4 py-3 pr-10 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
              >
            </div>
          </div>

          <!-- ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
          <div>
            <label class="block text-sm font-medium mb-2 text-[#1B3C53] dark:text-gray-300">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="relative">
              <span class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-[#456882] dark:text-gray-400 text-lg">lock</span>
              <input 
                v-model="form.password"
                :type="showPassword ? 'text' : 'password'"
                required
                placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ù‚ÙˆÙŠØ©"
                class="w-full px-4 py-3 pr-20 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
              >
              <button 
                type="button"
                @click="showPassword = !showPassword"
                class="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#456882] dark:text-gray-400 hover:text-[#1B3C53] dark:hover:text-white transition-colors duration-200"
              >
                <span class="material-icons text-lg">{{ showPassword ? 'visibility_off' : 'visibility' }}</span>
              </button>
            </div>
            <p class="text-xs mt-2 text-[#456882] dark:text-gray-400">ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</p>
          </div>

          <!-- ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
          <div>
            <label class="block text-sm font-medium mb-2 text-[#1B3C53] dark:text-gray-300">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
            <div class="relative">
              <span class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-[#456882] dark:text-gray-400 text-lg">lock</span>
              <input 
                v-model="form.confirmPassword"
                :type="showConfirmPassword ? 'text' : 'password'"
                required
                placeholder="Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
                class="w-full px-4 py-3 pr-20 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
              >
              <button 
                type="button"
                @click="showConfirmPassword = !showConfirmPassword"
                class="absolute left-3 top-1/2 transform -translate-y-1/2 text-[#456882] dark:text-gray-400 hover:text-[#1B3C53] dark:hover:text-white transition-colors duration-200"
              >
                <span class="material-icons text-lg">{{ showConfirmPassword ? 'visibility_off' : 'visibility' }}</span>
              </button>
            </div>
          </div>

          <!-- Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨ -->
          <div>
            <label class="block text-sm font-medium mb-2 text-[#1B3C53] dark:text-gray-300">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <div class="relative">
              <span class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-[#456882] dark:text-gray-400 text-lg">person_outline</span>
              <select 
                v-model="form.accountType" 
                class="w-full px-4 py-3 pr-10 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white appearance-none transition-all duration-200"
              >
                <option value="parent">ÙˆÙ„ÙŠ Ø£Ù…Ø±</option>
                <option value="teacher">Ù…Ø¹Ù„Ù…</option>
                <option value="student">Ø·Ø§Ù„Ø¨</option>
              </select>
            </div>
            <p class="text-xs mt-2 text-[#456882] dark:text-gray-400">Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ø§Øª Ù…Ø¯ÙŠØ± Ø£Ùˆ Ù…ÙˆØ¸Ù Ù…Ù† Ù‡Ù†Ø§</p>
          </div>

          <!-- Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ -->
          <div>
            <label class="block text-sm font-medium mb-2 text-[#1B3C53] dark:text-gray-300">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <div class="relative">
              <span class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-[#456882] dark:text-gray-400 text-lg">phone</span>
              <input 
                type="tel" 
                v-model="form.phone"
                placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ"
                class="w-full px-4 py-3 pr-10 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
              >
            </div>
          </div>

          <!-- Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· -->
          <div class="flex items-start gap-3">
            <input 
              type="checkbox" 
              v-model="form.agreeTerms"
              required
              class="mt-1 rounded border-gray-300 dark:border-gray-600 focus:ring-[#1B3C53] bg-white dark:bg-gray-700"
            >
            <label class="text-sm text-[#1B3C53] dark:text-gray-300 flex-1">
              Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ 
              <a href="#" class="font-medium text-[#1B3C53] dark:text-blue-400 hover:underline transition-colors duration-200">Ø´Ø±ÙˆØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</a>
              Ùˆ
              <a href="#" class="font-medium text-[#1B3C53] dark:text-blue-400 hover:underline transition-colors duration-200">Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</a>
            </label>
          </div>

          <!-- Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ -->
          <div v-if="errorMessage" class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-600 dark:text-red-400 px-4 py-3 rounded-xl text-sm">
            {{ errorMessage }}
          </div>

          <!-- Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ -->
          <button 
            type="submit"
            :disabled="loading || !form.agreeTerms"
            class="w-full bg-gradient-to-r from-[#1B3C53] to-[#234C6A] text-white py-3 px-4 rounded-xl hover:from-[#234C6A] hover:to-[#1B3C53] transition-all duration-200 font-semibold disabled:opacity-50 disabled:cursor-not-allowed shadow-lg flex items-center justify-center gap-2"
          >
            <span v-if="loading" class="flex items-center justify-center gap-2">
              <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
              <span>Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨...</span>
            </span>
            <span v-else class="flex items-center justify-center gap-2">
              <span class="material-icons text-lg">person_add</span>
              <span>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span>
            </span>
          </button>

        </form>

        <!-- Ø§Ù„Ø®Ø· Ø§Ù„ÙØ§ØµÙ„ -->
        <div class="flex items-center my-6">
          <div class="flex-1 border-t border-gray-300 dark:border-gray-600"></div>
          <span class="px-4 text-sm text-[#456882] dark:text-gray-400">Ø£Ùˆ</span>
          <div class="flex-1 border-t border-gray-300 dark:border-gray-600"></div>
        </div>

        <!-- Ø±Ø§Ø¨Ø· ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div class="text-center">
          <p class="text-[#1B3C53] dark:text-gray-300">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ</p>
          <button @click="goToLogin" class="font-semibold mt-2 text-[#1B3C53] dark:text-blue-400 hover:underline transition-colors duration-200 flex items-center justify-center gap-2 mx-auto">
            <span class="material-icons text-lg">login</span>
            <span>Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¢Ù†</span>
          </button>
        </div>

      </div>

      <!-- Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
      <div class="text-center mt-6">
        <router-link to="/" class="inline-flex items-center gap-2 text-[#1B3C53] dark:text-gray-300 hover:text-[#234C6A] dark:hover:text-white transition-colors duration-200">
          <span class="material-icons">arrow_back</span>
          <span>Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
        </router-link>
      </div>

    </div>
  </div>
</template>

<script>
import { ref, computed, onMounted } from 'vue'
import { useRouter } from 'vue-router'

export default {
  name: 'Register',
  setup() {
    const router = useRouter()
    const loading = ref(false)
    const showPassword = ref(false)
    const showConfirmPassword = ref(false)
    const errorMessage = ref('')
    
    const form = ref({
      fullName: '',
      email: '',
      password: '',
      confirmPassword: '',
      accountType: 'parent',
      phone: '',
      agreeTerms: false
    })

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†
    const getExistingUsers = () => {
      try {
        return JSON.parse(localStorage.getItem('libraryUsers') || '[]')
      } catch (error) {
        console.error('Error loading users:', error)
        return []
      }
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    const getEmployees = () => {
      try {
        return JSON.parse(localStorage.getItem('libraryEmployees') || '[]')
      } catch (error) {
        console.error('Error loading employees:', error)
        return []
      }
    }

    // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const saveUser = (userData) => {
      const users = getExistingUsers()
      users.push(userData)
      localStorage.setItem('libraryUsers', JSON.stringify(users))
      
      // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
      updateEmployeeStats(userData)
    }

    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
    const updateEmployeeStats = (userData) => {
      const employees = getEmployees()
      const currentUser = JSON.parse(localStorage.getItem('userData') || '{}')
      
      if (currentUser.role === 'employee') {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§ØªÙ‡
        const updatedEmployees = employees.map(emp => {
          if (emp.id === currentUser.id) {
            const stats = emp.stats || {
              totalUsers: 0,
              parents: 0,
              teachers: 0,
              students: 0
            }
            
            stats.totalUsers++
            stats[`${userData.role}s`]++
            
            return {
              ...emp,
              stats,
              lastActivity: new Date().toISOString()
            }
          }
          return emp
        })
        
        localStorage.setItem('libraryEmployees', JSON.stringify(updatedEmployees))
      }
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const validateForm = () => {
      if (form.value.password.length < 6) {
        errorMessage.value = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'
        return false
      }

      if (form.value.password !== form.value.confirmPassword) {
        errorMessage.value = 'ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©'
        return false
      }

      if (!form.value.agreeTerms) {
        errorMessage.value = 'ÙŠØ¬Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙˆØ· ÙˆØ§Ù„Ø£Ø­ÙƒØ§Ù…'
        return false
      }

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
      const existingUsers = getExistingUsers()
      const userExists = existingUsers.find(user => user.email === form.value.email)
      if (userExists) {
        errorMessage.value = 'Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹'
        return false
      }

      errorMessage.value = ''
      return true
    }

    // Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙØ­Ø© Ù„Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„ÙŠÙ‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    const checkRedirectAfterAuth = () => {
      const redirectTo = localStorage.getItem('redirectAfterLogin')
      if (redirectTo) {
        localStorage.removeItem('redirectAfterLogin')
        return redirectTo
      }
      return null
    }

    // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ø¨ØªØºÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
    const notifyAuthChange = () => {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¯Ø« ØªØ®Ø²ÙŠÙ† Ù…Ø®ØµØµ
      const storageEvent = new StorageEvent('storage', {
        key: 'authToken',
        newValue: localStorage.getItem('authToken'),
        oldValue: null,
        url: window.location.href,
        storageArea: localStorage
      })
      window.dispatchEvent(storageEvent)
      
      // ØªØ­Ø¯ÙŠØ« Ù…Ø¨Ø§Ø´Ø± Ù„Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
      if (window.opener) {
        window.opener.postMessage({ type: 'AUTH_CHANGE', authenticated: true }, '*')
      }
      
      // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§ÙØ°
      window.postMessage({ type: 'AUTH_CHANGE', authenticated: true }, '*')
      
      // ØªØ­Ø¯ÙŠØ« localStorage Ù„Ø¥Ø·Ù„Ø§Ù‚ Ø§Ù„Ø­Ø¯Ø«
      const currentToken = localStorage.getItem('authToken')
      localStorage.setItem('authToken', currentToken)
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    const autoLoginAfterRegister = (userData) => {
      // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø©
      const token = `user-token-${Date.now()}`
      localStorage.setItem('authToken', token)
      localStorage.setItem('userData', JSON.stringify({
        id: userData.id,
        name: userData.name,
        email: userData.email,
        role: userData.role,
        avatar: userData.avatar,
        isAdmin: false,
        type: userData.role,
        phone: userData.phone || ''
      }))
      localStorage.setItem('userType', userData.role)

      // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø§Ø·
      localStorage.setItem('lastActivity', new Date().getTime().toString())

      console.log('âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:', userData)
      
      // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ø¨ØªØºÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©
      notifyAuthChange()
    }

    const handleRegister = async () => {
      if (!validateForm()) return

      loading.value = true

      try {
        // Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        await new Promise(resolve => setTimeout(resolve, 1500))

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
        const newUser = {
          id: Date.now(),
          name: form.value.fullName,
          email: form.value.email,
          password: form.value.password,
          role: form.value.accountType,
          phone: form.value.phone || null,
          avatar: form.value.fullName.charAt(0),
          isActive: true,
          createdAt: new Date().toISOString(),
          lastLogin: new Date().toISOString(),
          preferences: {
            language: 'ar',
            theme: 'light',
            notifications: true
          },
          stats: {
            storiesRead: 0,
            favorites: 0,
            readingTime: 0
          }
        }

        // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        saveUser(newUser)

        // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        autoLoginAfterRegister(newUser)

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØµÙØ­Ø© Ù„Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„ÙŠÙ‡Ø§
        const redirectTo = checkRedirectAfterAuth()
        if (redirectTo) {
          // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
          router.replace(redirectTo)
        } else {
          // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
          alert('ğŸ‰ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨Ùƒ ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!')
          router.push('/')
        }
        
      } catch (error) {
        console.error('âŒ Register error:', error)
        errorMessage.value = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.'
      } finally {
        loading.value = false
      }
    }

    const goToLogin = () => {
      router.push('/login')
    }

    // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„ØªØ·ÙˆÙŠØ±)
    onMounted(() => {
      const employees = getEmployees()
      const users = getExistingUsers()
      console.log('ğŸ‘¥ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', {
        totalUsers: users.length,
        parents: users.filter(u => u.role === 'parent').length,
        teachers: users.filter(u => u.role === 'teacher').length,
        students: users.filter(u => u.role === 'student').length,
        employees: employees.length
      })
    })

    return {
      form,
      loading,
      showPassword,
      showConfirmPassword,
      errorMessage,
      handleRegister,
      goToLogin
    }
  }
}
</script>

<style scoped>
@import url('https://fonts.googleapis.com/css2?family=Reem+Kufi:wght@400;500;600;700&display=swap');
@import url('https://fonts.googleapis.com/icon?family=Material+Icons');

/* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø­Ù‚ÙˆÙ„ */
input:focus, select:focus {
  outline: none;
  box-shadow: 0 0 0 2px rgba(27, 60, 83, 0.2);
}

/* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± select */
select {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23456882' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: left 0.75rem center;
  background-repeat: no-repeat;
  background-size: 16px 12px;
  padding-left: 2.5rem;
}

.dark select {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
}
</style>