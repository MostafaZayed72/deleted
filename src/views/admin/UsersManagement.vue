<template>
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900">        
    <main class="container mx-auto px-4 py-8">
      
      <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
      <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-[#1B3C53] dark:text-white mb-3">
          Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        </h1>
        <p class="text-lg text-[#456882] dark:text-gray-300">
          Ø¥Ø¯Ø§Ø±Ø© Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† ÙˆØ§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØªÙØ§Ø¹Ù„Ø§ØªÙ‡Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØµØ©
        </p>
      </div>

      <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 transition-all duration-300 hover:shadow-xl">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-[#456882] dark:text-gray-400 mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
              <p class="text-2xl font-bold text-[#1B3C53] dark:text-blue-400">{{ statistics.totalUsers }}</p>
            </div>
            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
              <span class="material-icons text-white">people</span>
            </div>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 transition-all duration-300 hover:shadow-xl">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-[#456882] dark:text-gray-400 mb-1">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø·ÙŠÙ†</p>
              <p class="text-2xl font-bold text-[#1B3C53] dark:text-green-400">{{ statistics.activeUsers }}</p>
            </div>
            <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
              <span class="material-icons text-white">check_circle</span>
            </div>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 transition-all duration-300 hover:shadow-xl">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-[#456882] dark:text-gray-400 mb-1">Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</p>
              <p class="text-2xl font-bold text-[#1B3C53] dark:text-red-400">{{ statistics.bannedUsers }}</p>
            </div>
            <div class="w-12 h-12 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg">
              <span class="material-icons text-white">block</span>
            </div>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 transition-all duration-300 hover:shadow-xl">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm text-[#456882] dark:text-gray-400 mb-1">Ø¬Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ…</p>
              <p class="text-2xl font-bold text-[#1B3C53] dark:text-purple-400">{{ statistics.newToday }}</p>
            </div>
            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center shadow-lg">
              <span class="material-icons text-white">person_add</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠØ³Ø±: Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ -->
        <div class="lg:col-span-1">
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6 sticky top-24">
            <div class="flex items-center gap-2 mb-6">
              <span class="material-icons text-[#1B3C53] dark:text-blue-400">person_add</span>
              <h3 class="text-lg font-bold text-[#1B3C53] dark:text-white">Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
            </div>
            
            <form @submit.prevent="addNewUser" class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-[#1B3C53] dark:text-gray-300 mb-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                <input 
                  v-model="newUser.fullName"
                  type="text"
                  required
                  placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„"
                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
                >
              </div>

              <div>
                <label class="block text-sm font-medium text-[#1B3C53] dark:text-gray-300 mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
                <input 
                  v-model="newUser.email"
                  type="email"
                  required
                  placeholder="Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
                >
              </div>

              <!-- ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø¹ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ -->
              <div>
                <label class="block text-sm font-medium text-[#1B3C53] dark:text-gray-300 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <div class="relative">
                  <input 
                    v-model="newUser.password"
                    :type="showPassword ? 'text' : 'password'"
                    required
                    placeholder="Ø§Ø®ØªØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±"
                    class="w-full px-4 py-2 pr-12 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
                  >
                  <button 
                    type="button"
                    @click="showPassword = !showPassword"
                    class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-[#1B3C53] dark:hover:text-blue-400 transition-colors duration-200"
                  >
                    <span class="material-icons text-sm">{{ showPassword ? 'visibility_off' : 'visibility' }}</span>
                  </button>
                </div>
                <p class="text-xs text-[#456882] dark:text-gray-400 mt-1">ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„</p>
              </div>

              <!-- Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨ -->
              <div>
                <label class="block text-sm font-medium text-[#1B3C53] dark:text-gray-300 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
                <select 
                  v-model="newUser.accountType"
                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200 appearance-none"
                >
                  <option value="parent">ÙˆÙ„ÙŠ Ø£Ù…Ø±</option>
                  <option value="teacher">Ù…Ø¹Ù„Ù…</option>
                  <option value="student">Ø·Ø§Ù„Ø¨</option>
                  <option value="employee">Ù…ÙˆØ¸Ù</option>
                  <option value="admin">Ø£Ø¯Ù…Ù†</option>
                </select>
              </div>

              <!-- Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ -->
              <div>
                <label class="block text-sm font-medium text-[#1B3C53] dark:text-gray-300 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input 
                  v-model="newUser.phone"
                  type="tel"
                  placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"
                  class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
                >
              </div>

              <button 
                type="submit"
                :disabled="addingUser"
                class="w-full bg-gradient-to-r from-[#1B3C53] to-[#234C6A] text-white py-3 px-4 rounded-xl hover:from-[#234C6A] hover:to-[#1B3C53] transition-all duration-200 font-medium shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
              >
                <span v-if="addingUser" class="flex items-center gap-2">
                  <div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                  Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...
                </span>
                <span v-else class="flex items-center gap-2">
                  <span class="material-icons text-sm">person_add</span>
                  Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù…
                </span>
              </button>
            </form>
          </div>
        </div>

        <!-- Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙŠÙ…Ù†: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙˆØ§Ù„ØªÙØ§Ø¹Ù„Ø§Øª -->
        <div class="lg:col-span-2 space-y-6">
          
          <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„Ø§ØªØ± -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 p-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="relative">
                <span class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-[#456882] dark:text-gray-400">search</span>
                <input 
                  v-model="searchQuery"
                  type="text"
                  placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ..."
                  class="w-full px-4 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
                >
              </div>
              
              <div class="relative">
                <span class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-[#456882] dark:text-gray-400">filter_alt</span>
                <select 
                  v-model="statusFilter"
                  class="w-full px-4 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white appearance-none"
                >
                  <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option>
                  <option value="active">Ù†Ø´Ø·</option>
                  <option value="banned">Ù…Ø­Ø¸ÙˆØ±</option>
                  <option value="inactive">ØºÙŠØ± Ù†Ø´Ø·</option>
                </select>
              </div>

              <div class="relative">
                <span class="material-icons absolute right-3 top-1/2 transform -translate-y-1/2 text-[#456882] dark:text-gray-400">category</span>
                <select 
                  v-model="typeFilter"
                  class="w-full px-4 py-2 pr-10 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white appearance-none"
                >
                  <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
                  <option value="parent">Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø£Ù…ÙˆØ±</option>
                  <option value="teacher">Ù…Ø¹Ù„Ù…ÙŠÙ†</option>
                  <option value="student">Ø·Ù„Ø§Ø¨</option>
                  <option value="employee">Ù…ÙˆØ¸ÙÙŠÙ†</option>
                  <option value="admin">Ø£Ø¯Ù…Ù†</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
          <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden">
            <div class="p-6 border-b border-gray-200 dark:border-gray-600">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-[#1B3C53] dark:text-white">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h3>
                <span class="text-sm text-[#456882] dark:text-gray-400">
                  Ø¹Ø±Ø¶ {{ filteredUsers.length }} Ù…Ù† {{ statistics.totalUsers }}
                </span>
              </div>
            </div>

            <div class="overflow-x-auto">
              <table class="w-full">
                <thead>
                  <tr class="border-b border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700">
                    <th class="text-right py-4 px-6 text-sm font-medium text-[#1B3C53] dark:text-gray-300">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                    <th class="text-right py-4 px-6 text-sm font-medium text-[#1B3C53] dark:text-gray-300">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</th>
                    <th class="text-right py-4 px-6 text-sm font-medium text-[#1B3C53] dark:text-gray-300">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th class="text-right py-4 px-6 text-sm font-medium text-[#1B3C53] dark:text-gray-300">Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                    <th class="text-right py-4 px-6 text-sm font-medium text-[#1B3C53] dark:text-gray-300">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                  </tr>
                </thead>
                <tbody>
                  <tr 
                    v-for="user in filteredUsers" 
                    :key="user.id"
                    class="border-b border-gray-200 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200"
                  >
                    <td class="py-4 px-6">
                      <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                          <span class="material-icons">person</span>
                        </div>
                        <div class="flex-1 min-w-0">
                          <h4 class="font-semibold text-[#1B3C53] dark:text-white text-sm mb-1">{{ user.fullName }}</h4>
                          <p class="text-sm text-[#456882] dark:text-gray-400 mb-1">{{ user.email }}</p>
                          <p v-if="user.phone" class="text-xs text-[#456882] dark:text-gray-400">{{ user.phone }}</p>
                        </div>
                      </div>
                    </td>
                    <td class="py-4 px-6">
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium" 
                            :class="getAccountTypeClass(user.accountType)">
                        <span class="material-icons text-xs mr-1">{{ getAccountTypeIcon(user.accountType) }}</span>
                        {{ getAccountTypeArabic(user.accountType) }}
                      </span>
                    </td>
                    <td class="py-4 px-6">
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium" 
                            :class="getStatusClass(user.status)">
                        <span class="material-icons text-xs mr-1">{{ getStatusIcon(user.status) }}</span>
                        {{ getStatusArabic(user.status) }}
                      </span>
                    </td>
                    <td class="py-4 px-6 text-sm text-[#456882] dark:text-gray-400">
                      {{ formatDate(user.createdAt) }}
                    </td>
                    <td class="py-4 px-6">
                      <div class="flex items-center gap-1 justify-end">
                        <button 
                          @click="editUser(user)"
                          class="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition-colors duration-200"
                          title="ØªØ¹Ø¯ÙŠÙ„"
                        >
                          <span class="material-icons text-sm">edit</span>
                        </button>
                        <button 
                          @click="toggleUserStatus(user)"
                          class="p-2 text-orange-600 hover:bg-orange-50 dark:hover:bg-orange-900/20 rounded-lg transition-colors duration-200"
                          :title="user.status === 'banned' ? 'ÙÙƒ Ø§Ù„Ø­Ø¸Ø±' : 'Ø­Ø¸Ø±'"
                        >
                          <span class="material-icons text-sm">{{ user.status === 'banned' ? 'lock_open' : 'block' }}</span>
                        </button>
                        <button 
                          @click="copyLoginInfo(user)"
                          class="p-2 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded-lg transition-colors duration-200"
                          title="Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„"
                        >
                          <span class="material-icons text-sm">content_copy</span>
                        </button>
                        <button 
                          @click="viewUserInteractions(user)"
                          class="p-2 text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/20 rounded-lg transition-colors duration-200"
                          title="Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª"
                        >
                          <span class="material-icons text-sm">insights</span>
                        </button>
                        <button 
                          @click="deleteUser(user)"
                          class="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-colors duration-200"
                          title="Ø­Ø°Ù"
                        >
                          <span class="material-icons text-sm">delete</span>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>

              <!-- Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
              <div v-if="filteredUsers.length === 0" class="text-center py-12">
                <div class="w-16 h-16 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
                  <span class="material-icons text-gray-400 text-2xl">search_off</span>
                </div>
                <h3 class="text-lg font-medium text-[#1B3C53] dark:text-white mb-2">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</h3>
                <p class="text-[#456882] dark:text-gray-400">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙŠØ·Ø§Ø¨Ù‚ÙˆÙ† Ø¨Ø­Ø«Ùƒ</p>
              </div>
            </div>
          </div>

          <!-- ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ¯) -->
          <div v-if="selectedUser" class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700">
            <div class="p-6 border-b border-gray-200 dark:border-gray-600">
              <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-[#1B3C53] dark:text-white">ØªÙØ§Ø¹Ù„Ø§Øª {{ selectedUser.fullName }}</h3>
                <button 
                  @click="selectedUser = null"
                  class="p-2 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors duration-200"
                >
                  <span class="material-icons">close</span>
                </button>
              </div>
            </div>

            <div class="p-6">
              <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
              <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="text-center p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                  <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">{{ selectedUser.stats?.totalInteractions || 0 }}</div>
                  <div class="text-sm text-blue-600 dark:text-blue-300">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙØ§Ø¹Ù„Ø§Øª</div>
                </div>
                <div class="text-center p-4 bg-green-50 dark:bg-green-900/20 rounded-xl">
                  <div class="text-2xl font-bold text-green-600 dark:text-green-400">{{ selectedUser.stats?.views || 0 }}</div>
                  <div class="text-sm text-green-600 dark:text-green-300">Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</div>
                </div>
                <div class="text-center p-4 bg-purple-50 dark:bg-purple-900/20 rounded-xl">
                  <div class="text-2xl font-bold text-purple-600 dark:text-purple-400">{{ selectedUser.stats?.comments || 0 }}</div>
                  <div class="text-sm text-purple-600 dark:text-purple-300">Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</div>
                </div>
                <div class="text-center p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-xl">
                  <div class="text-2xl font-bold text-yellow-600 dark:text-yellow-400">{{ selectedUser.stats?.readingTime || 0 }} Ø¯</div>
                  <div class="text-sm text-yellow-600 dark:text-yellow-300">ÙˆÙ‚Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</div>
                </div>
              </div>

              <!-- Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª -->
              <div class="mb-6">
                <h4 class="text-md font-semibold text-[#1B3C53] dark:text-white mb-4 flex items-center gap-2">
                  <span class="material-icons text-blue-500">chat</span>
                  Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
                </h4>
                <div class="space-y-3">
                  <div 
                    v-for="comment in selectedUser.comments" 
                    :key="comment.id"
                    class="border border-gray-200 dark:border-gray-600 rounded-xl p-4 hover:border-blue-300 dark:hover:border-blue-600 transition-all duration-200"
                  >
                    <div class="flex justify-between items-start mb-2">
                      <p class="text-sm text-[#1B3C53] dark:text-white font-medium">Ø¹Ù„Ù‰: {{ comment.storyTitle }}</p>
                      <span class="text-xs text-[#456882] dark:text-gray-400">{{ formatDate(comment.date) }}</span>
                    </div>
                    <p class="text-[#1B3C53] dark:text-gray-300 text-sm mb-2">{{ comment.text }}</p>
                    <div class="flex items-center gap-2">
                      <button 
                        @click="deleteComment(comment)"
                        class="text-red-600 hover:text-red-800 dark:hover:text-red-400 text-xs transition-colors duration-200 flex items-center gap-1"
                      >
                        <span class="material-icons text-xs">delete</span>
                        Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚
                      </button>
                      <button 
                        v-if="!comment.hidden"
                        @click="hideComment(comment)"
                        class="text-orange-600 hover:text-orange-800 dark:hover:text-orange-400 text-xs transition-colors duration-200 flex items-center gap-1"
                      >
                        <span class="material-icons text-xs">visibility_off</span>
                        Ø¥Ø®ÙØ§Ø¡
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª -->
              <div>
                <h4 class="text-md font-semibold text-[#1B3C53] dark:text-white mb-4 flex items-center gap-2">
                  <span class="material-icons text-yellow-500">star</span>
                  Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
                </h4>
                <div class="space-y-3">
                  <div 
                    v-for="rating in selectedUser.ratings" 
                    :key="rating.id"
                    class="border border-gray-200 dark:border-gray-600 rounded-xl p-4 hover:border-yellow-300 dark:hover:border-yellow-600 transition-all duration-200"
                  >
                    <div class="flex justify-between items-center mb-2">
                      <p class="text-sm text-[#1B3C53] dark:text-white font-medium">{{ rating.storyTitle }}</p>
                      <div class="flex items-center gap-1 text-yellow-500">
                        <span v-for="star in 5" :key="star" class="text-sm">
                          {{ star <= rating.value ? 'â˜…' : 'â˜†' }}
                        </span>
                      </div>
                    </div>
                    <p class="text-xs text-[#456882] dark:text-gray-400">{{ formatDate(rating.date) }}</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Ù†Ø§ÙØ°Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
    <div v-if="editingUser" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
      <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl max-w-md w-full p-6">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-lg font-bold text-[#1B3C53] dark:text-white">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
          <button 
            @click="editingUser = null"
            class="p-1 text-gray-500 hover:text-gray-700 dark:hover:text-gray-300 transition-colors duration-200"
          >
            <span class="material-icons">close</span>
          </button>
        </div>
        
        <form @submit.prevent="updateUser" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-[#1B3C53] dark:text-gray-300 mb-2">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input 
              v-model="editingUser.fullName"
              type="text"
              required
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
            >
          </div>

          <div>
            <label class="block text-sm font-medium text-[#1B3C53] dark:text-gray-300 mb-2">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
            <input 
              v-model="editingUser.email"
              type="email"
              required
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
            >
          </div>

          <!-- ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø¹ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ -->
          <div>
            <label class="block text-sm font-medium text-[#1B3C53] dark:text-gray-300 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <div class="relative">
              <input 
                v-model="editingUser.newPassword"
                :type="showEditPassword ? 'text' : 'password'"
                placeholder="Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©"
                class="w-full px-4 py-2 pr-12 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
              >
              <button 
                type="button"
                @click="showEditPassword = !showEditPassword"
                class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-[#1B3C53] dark:hover:text-blue-400 transition-colors duration-200"
              >
                <span class="material-icons text-sm">{{ showEditPassword ? 'visibility_off' : 'visibility' }}</span>
              </button>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-[#1B3C53] dark:text-gray-300 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨</label>
            <select 
              v-model="editingUser.accountType"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200 appearance-none"
            >
              <option value="parent">ÙˆÙ„ÙŠ Ø£Ù…Ø±</option>
              <option value="teacher">Ù…Ø¹Ù„Ù…</option>
              <option value="student">Ø·Ø§Ù„Ø¨</option>
              <option value="employee">Ù…ÙˆØ¸Ù</option>
              <option value="admin">Ø£Ø¯Ù…Ù†</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-[#1B3C53] dark:text-gray-300 mb-2">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select 
              v-model="editingUser.status"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200 appearance-none"
            >
              <option value="active">Ù†Ø´Ø·</option>
              <option value="inactive">ØºÙŠØ± Ù†Ø´Ø·</option>
              <option value="banned">Ù…Ø­Ø¸ÙˆØ±</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-[#1B3C53] dark:text-gray-300 mb-2">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
            <input 
              v-model="editingUser.phone"
              type="tel"
              placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ"
              class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-[#1B3C53] focus:border-transparent bg-white dark:bg-gray-700 text-gray-800 dark:text-white transition-all duration-200"
            >
          </div>

          <div class="flex items-center gap-3 pt-4">
            <button 
              type="submit"
              class="flex-1 bg-gradient-to-r from-[#1B3C53] to-[#234C6A] text-white py-3 px-4 rounded-xl hover:from-[#234C6A] hover:to-[#1B3C53] transition-all duration-200 font-medium shadow-lg"
            >
              Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
            </button>
            <button 
              type="button"
              @click="editingUser = null"
              class="flex-1 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 py-3 px-4 rounded-xl hover:bg-gray-400 dark:hover:bg-gray-500 transition-all duration-200 font-medium"
            >
              Ø¥Ù„ØºØ§Ø¡
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</template>

<script>
import { ref, computed, onMounted, onUnmounted } from 'vue'
import AppHeader from '@/components/Header.vue'
import StatisticsManager from '@/utils/statisticsManager'

export default {
  name: 'UsersManagement',
  components: {
    AppHeader
  },
  setup() {
    const users = ref([])
    const searchQuery = ref('')
    const statusFilter = ref('all')
    const typeFilter = ref('all')
    const selectedUser = ref(null)
    const editingUser = ref(null)
    const addingUser = ref(false)
    const showPassword = ref(false)
    const showEditPassword = ref(false)
    
    const newUser = ref({
      fullName: '',
      email: '',
      password: '',
      accountType: 'parent',
      phone: ''
    })

    const statistics = ref({
      totalUsers: 0,
      activeUsers: 0,
      bannedUsers: 0,
      newToday: 0
    })

    // Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø­Ø¸ÙŠ
    const setupRealTimeUpdates = () => {
      window.addEventListener('usersUpdated', loadUsers)
      window.addEventListener('interactionsUpdated', loadUsers)
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    const loadUsers = () => {
      try {
        const storedUsers = JSON.parse(localStorage.getItem('libraryUsers') || '[]')
        users.value = storedUsers.map(user => ({
          ...user,
          stats: StatisticsManager.getUserStatistics(user.id)
        }))

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const today = new Date().toDateString()
        statistics.value = {
          totalUsers: storedUsers.length,
          activeUsers: storedUsers.filter(u => u.status === 'active').length,
          bannedUsers: storedUsers.filter(u => u.status === 'banned').length,
          newToday: storedUsers.filter(u => new Date(u.createdAt).toDateString() === today).length
        }
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', error)
        users.value = []
      }
    }

    // Computed property Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
    const filteredUsers = computed(() => {
      return users.value.filter(user => {
        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¨Ø­Ø«
        if (searchQuery.value && !user.fullName.toLowerCase().includes(searchQuery.value.toLowerCase()) &&
            !user.email.toLowerCase().includes(searchQuery.value.toLowerCase())) {
          return false
        }
        
        // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø©
        if (statusFilter.value !== 'all' && user.status !== statusFilter.value) {
          return false
        }
        
        // ØªØ·Ø¨ÙŠÙ‚ ÙÙ„ØªØ± Ø§Ù„Ù†ÙˆØ¹
        if (typeFilter.value !== 'all' && user.accountType !== typeFilter.value) {
          return false
        }
        
        return true
      })
    })

    // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ÙˆØ§Ù„ØªØµÙ†ÙŠÙØ§Øª
    const getAccountTypeIcon = (type) => {
      const icons = {
        parent: 'family_restroom',
        teacher: 'school',
        student: 'child_care',
        employee: 'badge',
        admin: 'admin_panel_settings'
      }
      return icons[type] || 'person'
    }

    const getAccountTypeArabic = (type) => {
      const types = {
        parent: 'ÙˆÙ„ÙŠ Ø£Ù…Ø±',
        teacher: 'Ù…Ø¹Ù„Ù…',
        student: 'Ø·Ø§Ù„Ø¨',
        employee: 'Ù…ÙˆØ¸Ù',
        admin: 'Ø£Ø¯Ù…Ù†'
      }
      return types[type] || type
    }

    const getAccountTypeClass = (type) => {
      const classes = {
        parent: 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400',
        teacher: 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400',
        student: 'bg-purple-100 text-purple-800 dark:bg-purple-900/20 dark:text-purple-400',
        employee: 'bg-orange-100 text-orange-800 dark:bg-orange-900/20 dark:text-orange-400',
        admin: 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400'
      }
      return classes[type] || 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400'
    }

    const getStatusIcon = (status) => {
      const icons = {
        active: 'check_circle',
        inactive: 'pause_circle',
        banned: 'block'
      }
      return icons[status] || 'help'
    }

    const getStatusArabic = (status) => {
      const statuses = {
        active: 'Ù†Ø´Ø·',
        inactive: 'ØºÙŠØ± Ù†Ø´Ø·',
        banned: 'Ù…Ø­Ø¸ÙˆØ±'
      }
      return statuses[status] || status
    }

    const getStatusClass = (status) => {
      const classes = {
        active: 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400',
        inactive: 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400',
        banned: 'bg-red-100 text-red-800 dark:bg-red-900/20 dark:text-red-400'
      }
      return classes[status] || 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400'
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
    const formatDate = (date) => {
      return new Date(date).toLocaleDateString('ar-SA', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      })
    }

    // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
    const addNewUser = async () => {
      addingUser.value = true
      try {
        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
        const user = {
          id: Date.now().toString(),
          ...newUser.value,
          status: 'active',
          createdAt: new Date().toISOString(),
          lastActivity: new Date().toISOString()
        }
        users.value.unshift(user)
        
        // Ø­ÙØ¸ ÙÙŠ localStorage
        const storedUsers = JSON.parse(localStorage.getItem('libraryUsers') || '[]')
        storedUsers.unshift(user)
        localStorage.setItem('libraryUsers', JSON.stringify(storedUsers))

        // Ø¥Ø·Ù„Ø§Ù‚ Ø­Ø¯Ø« Ø§Ù„ØªØ­Ø¯ÙŠØ«
        window.dispatchEvent(new CustomEvent('usersUpdated'))

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        newUser.value = {
          fullName: '',
          email: '',
          password: '',
          accountType: 'parent',
          phone: ''
        }

        alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­')
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯:', error)
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')
      } finally {
        addingUser.value = false
      }
    }

    const editUser = (user) => {
      editingUser.value = { ...user, newPassword: '' }
    }

    const updateUser = async () => {
      try {
        const index = users.value.findIndex(u => u.id === editingUser.value.id)
        if (index !== -1) {
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
          const updatedUser = { ...editingUser.value }
          if (updatedUser.newPassword) {
            updatedUser.password = updatedUser.newPassword
          }
          delete updatedUser.newPassword
          users.value[index] = updatedUser

          // ØªØ­Ø¯ÙŠØ« ÙÙŠ localStorage
          const storedUsers = JSON.parse(localStorage.getItem('libraryUsers') || '[]')
          const storedIndex = storedUsers.findIndex(u => u.id === updatedUser.id)
          if (storedIndex !== -1) {
            storedUsers[storedIndex] = updatedUser
            localStorage.setItem('libraryUsers', JSON.stringify(storedUsers))
            
            // Ø¥Ø·Ù„Ø§Ù‚ Ø­Ø¯Ø« Ø§Ù„ØªØ­Ø¯ÙŠØ«
            window.dispatchEvent(new CustomEvent('usersUpdated'))
          }
        }
        editingUser.value = null
        alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­')
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error)
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')
      }
    }

    const deleteUser = async (user) => {
      if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${user.fullName}ØŸ`)) {
        try {
          // Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
          users.value = users.value.filter(u => u.id !== user.id)
          
          // Ø­Ø°Ù Ù…Ù† localStorage
          const storedUsers = JSON.parse(localStorage.getItem('libraryUsers') || '[]')
          localStorage.setItem('libraryUsers', JSON.stringify(storedUsers.filter(u => u.id !== user.id)))

          // Ø¥Ø·Ù„Ø§Ù‚ Ø­Ø¯Ø« Ø§Ù„ØªØ­Ø¯ÙŠØ«
          window.dispatchEvent(new CustomEvent('usersUpdated'))

          alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­')
        } catch (error) {
          console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error)
          alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')
        }
      }
    }

    const toggleUserStatus = async (user) => {
      try {
        const newStatus = user.status === 'banned' ? 'active' : 'banned'
        user.status = newStatus
        
        // ØªØ­Ø¯ÙŠØ« ÙÙŠ localStorage
        const storedUsers = JSON.parse(localStorage.getItem('libraryUsers') || '[]')
        const storedUser = storedUsers.find(u => u.id === user.id)
        if (storedUser) {
          storedUser.status = newStatus
          localStorage.setItem('libraryUsers', JSON.stringify(storedUsers))
          
          // Ø¥Ø·Ù„Ø§Ù‚ Ø­Ø¯Ø« Ø§Ù„ØªØ­Ø¯ÙŠØ«
          window.dispatchEvent(new CustomEvent('usersUpdated'))
        }

        alert(`âœ… ØªÙ… ${newStatus === 'banned' ? 'Ø­Ø¸Ø±' : 'ÙÙƒ Ø­Ø¸Ø±'} Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­`)
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error)
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…')
      }
    }

    const viewUserInteractions = (user) => {
      selectedUser.value = {
        ...user,
        stats: StatisticsManager.getUserStatistics(user.id),
        comments: [], // ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        ratings: []   // ÙŠÙ…ÙƒÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      }
    }

    const copyLoginInfo = async (user) => {
      try {
        const info = `Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: ${user.email}\nÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: ${user.password || '*****'}`
        await navigator.clipboard.writeText(info)
        alert('âœ… ØªÙ… Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„')
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„:', error)
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù†Ø³Ø® Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„')
      }
    }

    const deleteComment = async (comment) => {
      try {
        selectedUser.value.comments = selectedUser.value.comments.filter(c => c.id !== comment.id)
        alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­')
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚:', error)
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„ØªØ¹Ù„ÙŠÙ‚')
      }
    }

    const hideComment = async (comment) => {
      try {
        comment.hidden = true
        alert('âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­')
      } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚:', error)
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚')
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù…ÙƒÙˆÙ†
    onMounted(() => {
      console.log('ğŸš€ ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†')
      loadUsers()
      setupRealTimeUpdates()
      
      // ØªÙ†Ø¸ÙŠÙ event listeners Ø¹Ù†Ø¯ ØªØ¯Ù…ÙŠØ± Ø§Ù„Ù…ÙƒÙˆÙ†
      onUnmounted(() => {
        window.removeEventListener('usersUpdated', loadUsers)
        window.removeEventListener('interactionsUpdated', loadUsers)
      })
    })

    return {
      users,
      searchQuery,
      statusFilter,
      typeFilter,
      selectedUser,
      editingUser,
      addingUser,
      showPassword,
      showEditPassword,
      newUser,
      statistics,
      filteredUsers,
      addNewUser,
      editUser,
      updateUser,
      deleteUser,
      toggleUserStatus,
      viewUserInteractions,
      deleteComment,
      hideComment,
      copyLoginInfo,
      getAccountTypeArabic,
      getAccountTypeClass,
      getAccountTypeIcon,
      getStatusArabic,
      getStatusClass,
      getStatusIcon,
      formatDate
    }
  }
}
</script>

<style scoped>
/* ØªØ­Ø³ÙŠÙ†Ø§Øª select */
select {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23456882' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  background-position: left 0.75rem center;
  background-repeat: no-repeat;
  background-size: 16px 12px;
  padding-left: 2.5rem;
}

.dark select {
  background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
}

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media (max-width: 768px) {
  .container {
    padding-left: 1rem;
    padding-right: 1rem;
  }
  
  table {
    font-size: 0.875rem;
  }
  
  .text-3xl {
    font-size: 1.5rem;
  }
}
</style>